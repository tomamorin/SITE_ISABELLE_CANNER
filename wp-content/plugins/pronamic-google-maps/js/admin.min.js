!function(a){var b=function(b,c){var d=this,e=a(b),f=null,g=null,h={};h.description=e.find("#pgm-description-field"),h.address=e.find("#pgm-address-field"),h.latitude=e.find("#pgm-lat-field"),h.longitude=e.find("#pgm-lng-field"),h.mapType=e.find("#pgm-map-type-field"),h.zoom=e.find("#pgm-zoom-field");var i=e.find("#pgm-canvas").get(0);if(i){var j=new google.maps.LatLng(h.latitude.val(),h.longitude.val()),k=parseInt(h.zoom.val(),10);isNaN(k)&&(k=0);var l=h.mapType.val();""===l&&(l=google.maps.MapTypeId.ROADMAP);var m={zoom:k,center:j,mapTypeId:l};f=new google.maps.Map(i,m);var n=new google.maps.Geocoder;g=new google.maps.Marker({position:j,map:f,draggable:!0});var o=new google.maps.InfoWindow({content:h.description.val()});o.open(f,g),e.find("#pgm-geocode-button").click(function(){return d.geocode(),!1}),e.find("#pgm-reverse-geocode-button").click(function(){return d.reverseGeocode(),!1})}this.updateMarker=function(){var a=new google.maps.LatLng(h.latitude.val(),h.longitude.val());g.setPosition(a),f.setCenter(a)},this.updateFields=function(){var a=g.getPosition();h.latitude.val(a.lat()),h.longitude.val(a.lng()),h.zoom.val(f.getZoom()),h.mapType.val(f.getMapTypeId())},this.geocode=function(){var a=h.address.val(),b=a.replace(/(\r\n|[\r\n])/g,", ");n.geocode({address:b},function(a,b){if(google.maps.GeocoderStatus.OK===b&&a[0]){var c=a[0].geometry.location,d=a[0].geometry.viewport;h.latitude.val(c.lat()),h.longitude.val(c.lng()),g.setPosition(c),f.setCenter(c),f.fitBounds(d)}})},this.reverseGeocode=function(){var a=new google.maps.LatLng(h.latitude.val(),h.longitude.val());n.geocode({latLng:a},function(a,b){if(google.maps.GeocoderStatus.OK===b&&a[0]){var c=a[0].formatted_address;h.address.val(c)}})},google.maps.event.addListener(f,"maptypeid_changed",d.updateFields),google.maps.event.addListener(f,"zoom_changed",d.updateFields),google.maps.event.addListener(g,"drag",d.updateFields),google.maps.event.addListener(g,"dragend",d.updateFields),h.latitude.keyup(d.updateMarker),h.latitude.change(d.updateMarker),h.longitude.keyup(d.updateMarker),h.longitude.change(d.updateMarker),h.description.keyup(function(){o.setContent(h.description.val())}),h.description.change(function(){o.setContent(h.description.val())})},c=function(b,c){var d=a(b),e={};e.latitude=d.find(".latitude-field"),e.longitude=d.find(".longitude-field"),e.description=d.find(".description-field"),e.mapType=d.find(".map-type-field"),e.zoom=d.find(".zoom-field");var f=b.find(".google-maps-canvas"),g=new google.maps.LatLng(e.latitude.val(),e.longitude.val()),h=parseInt(e.zoom.val(),10);isNaN(h)&&(h=0);var i=e.mapType.val();""===i&&(i=google.maps.MapTypeId.ROADMAP);var j={zoom:h,center:g,mapTypeId:i},k=new google.maps.Map(f.get(0),j),l=new google.maps.Marker({position:g,map:k,draggable:!0}),m=new google.maps.InfoWindow({content:e.description.val()});m.open(k,l);var n=function(){var a=new google.maps.LatLng(e.latitude.val(),e.longitude.val());l.setPosition(a),k.setCenter(a)},o=function(){var a=l.getPosition();e.latitude.val(a.lat()),e.longitude.val(a.lng()),e.zoom.val(k.getZoom()),e.mapType.val(k.getMapTypeId())};google.maps.event.addListener(k,"maptypeid_changed",o),google.maps.event.addListener(k,"zoom_changed",o),google.maps.event.addListener(l,"drag",o),google.maps.event.addListener(l,"dragend",o),e.latitude.keyup(n).change(n),e.longitude.keyup(n).change(n),e.description.change(function(){m.setContent(e.description.val())}),e.description.keyup(function(){m.setContent(e.description.val())});var p=function(){google.maps.event.trigger(k,"resize"),k.setCenter(g)};b.closest(".widget").find(".widget-action").click(function(){setTimeout(p,1e3)})},d=function(b,c){var d=this,e=a(b),f={};f.ID=e.find("#pgm-id-field"),f.title=e.find("#pgm-title-field"),f.address=e.find("#pgm-address-field"),f.latitude=e.find("#pgm-lat-field"),f.longitude=e.find("#pgm-lng-field"),f.mapType=e.find("#pgm-map-type-field"),f.zoom=e.find("#pgm-zoom-field"),f.foundPosts=e.find("#pgm-found-posts"),f.status=e.find("#pgm-status-field");var g=new google.maps.Geocoder;b.find("#submit").click(function(){return d.startGeocode(),!1}),this.startGeocode=function(){var c=f.address.val(),e=c.replace(/(\r\n|[\r\n])/g,", ");g.geocode({address:e},function(c,e){if(f.status.val(e),google.maps.GeocoderStatus.OK===e&&c[0]){var g=c[0].geometry.location;c[0].geometry.viewport;f.latitude.val(g.lat()),f.longitude.val(g.lng())}a.post(ajaxurl,b.serialize(),function(a){d.updateFields(a)})})},this.updateFields=function(a){if(f.foundPosts.text(a.foundPosts),a.nextPost){var c=a.nextPost;f.ID.val(c.ID),f.title.val(c.title),f.address.val(c.address),f.latitude.val(c.latitude),f.longitude.val(c.longitude),d.startGeocode()}else b.hide()}};a.fn.pronamicGoogleMapsMetaBox=function(c){return this.each(function(){var d=a(this);if(!d.data("pgm-meta-box")){var e=new b(this,c);d.data("pgm-meta-box",e)}})},a.fn.pronamicGoogleMapsWidget=function(b){return this.each(function(){var d=a(this);if(!d.data("pgm-widget")){var e=new c(this,b);d.data("pgm-widget",e)}})},a.fn.pronamicGoogleMapsGeocoder=function(b){return this.each(function(){var c=a(this);if(!c.data("pgm-geocoder")){var e=new d(this,b);c.data("pgm-geocoder",e)}})};var e=function(){google.maps.visualRefresh=pronamic_google_maps_settings.visualRefresh,a("#pronamic-google-maps-meta-box").pronamicGoogleMapsMetaBox(),a("#pgm-geocoder").pronamicGoogleMapsGeocoder(),a("#widgets-right .pronamic-google-maps-widget").pronamicGoogleMapsWidget(),jQuery('div[id$="_pronamic_google_maps-__i__"]').bind("dragstop",function(){a("#widgets-right .pronamic-google-maps-widget").pronamicGoogleMapsWidget()})};a(document).ready(function(){e()})}(jQuery);