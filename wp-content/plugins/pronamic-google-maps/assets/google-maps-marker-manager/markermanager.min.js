function MarkerManager(a,b){var c=this;c.map_=a,c.mapZoom_=a.getZoom(),c.projectionHelper_=new ProjectionHelperOverlay(a),google.maps.event.addListener(c.projectionHelper_,"ready",function(){c.projection_=this.getProjection(),c.initialize(a,b)})}function GridBounds(a){this.minX=Math.min(a[0].x,a[1].x),this.maxX=Math.max(a[0].x,a[1].x),this.minY=Math.min(a[0].y,a[1].y),this.maxY=Math.max(a[0].y,a[1].y)}function ProjectionHelperOverlay(a){this.setMap(a);this._map=a,this._zoom=-1,this._X0=this._Y0=this._X1=this._Y1=-1}MarkerManager.prototype.initialize=function(a,b){var c=this;b=b||{},c.tileSize_=MarkerManager.DEFAULT_TILE_SIZE_;var d=a.mapTypes,e=1;for(var f in d)if(d.hasOwnProperty(f)&&d.get(f)&&"number"===d.get(f).maxZoom){var g=a.mapTypes.get(f).maxZoom;g>e&&(e=g)}c.maxZoom_=b.maxZoom||19,c.trackMarkers_=b.trackMarkers,c.show_=b.show||!0;var h;h="number"==typeof b.borderPadding?b.borderPadding:MarkerManager.DEFAULT_BORDER_PADDING_,c.swPadding_=new google.maps.Size(-h,h),c.nePadding_=new google.maps.Size(h,-h),c.borderPadding_=h,c.gridWidth_={},c.grid_={},c.grid_[c.maxZoom_]={},c.numMarkers_={},c.numMarkers_[c.maxZoom_]=0,google.maps.event.addListener(a,"dragend",function(){c.onMapMoveEnd_()}),google.maps.event.addListener(a,"idle",function(){c.onMapMoveEnd_()}),google.maps.event.addListener(a,"zoom_changed",function(){c.onMapMoveEnd_()}),c.removeOverlay_=function(a){a.setMap(null),c.shownMarkers_--},c.addOverlay_=function(a){c.show_&&(a.setMap(c.map_),c.shownMarkers_++)},c.resetManager_(),c.shownMarkers_=0,c.shownBounds_=c.getMapGridBounds_(),google.maps.event.trigger(c,"loaded")},MarkerManager.DEFAULT_TILE_SIZE_=1024,MarkerManager.DEFAULT_BORDER_PADDING_=100,MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE=256,MarkerManager.prototype.resetManager_=function(){for(var a=MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE,b=0;b<=this.maxZoom_;++b)this.grid_[b]={},this.numMarkers_[b]=0,this.gridWidth_[b]=Math.ceil(a/this.tileSize_),a<<=1},MarkerManager.prototype.clearMarkers=function(){this.processAll_(this.shownBounds_,this.removeOverlay_),this.resetManager_()},MarkerManager.prototype.getTilePoint_=function(a,b,c){var d=this.projectionHelper_.LatLngToPixel(a,b),e=new google.maps.Point(Math.floor((d.x+c.width)/this.tileSize_),Math.floor((d.y+c.height)/this.tileSize_));return e},MarkerManager.prototype.addMarkerBatch_=function(a,b,c){var d=this,e=a.getPosition();a.MarkerManager_minZoom=b,this.trackMarkers_&&google.maps.event.addListener(a,"changed",function(a,b,c){d.onMarkerMoved_(a,b,c)});for(var f=this.getTilePoint_(e,c,new google.maps.Size(0,0,0,0)),g=c;g>=b;g--){var h=this.getGridCellCreate_(f.x,f.y,g);h.push(a),f.x=f.x>>1,f.y=f.y>>1}},MarkerManager.prototype.isGridPointVisible_=function(a){var b=this.shownBounds_.minY<=a.y&&a.y<=this.shownBounds_.maxY,c=this.shownBounds_.minX,d=c<=a.x&&a.x<=this.shownBounds_.maxX;if(!d&&0>c){var e=this.gridWidth_[this.shownBounds_.z];d=c+e<=a.x&&a.x<=e-1}return b&&d},MarkerManager.prototype.onMarkerMoved_=function(a,b,c){for(var d=this.maxZoom_,e=!1,f=this.getTilePoint_(b,d,new google.maps.Size(0,0,0,0)),g=this.getTilePoint_(c,d,new google.maps.Size(0,0,0,0));d>=0&&(f.x!==g.x||f.y!==g.y);){var h=this.getGridCellNoCreate_(f.x,f.y,d);h&&this.removeFromArray_(h,a)&&this.getGridCellCreate_(g.x,g.y,d).push(a),d===this.mapZoom_&&(this.isGridPointVisible_(f)?this.isGridPointVisible_(g)||(this.removeOverlay_(a),e=!0):this.isGridPointVisible_(g)&&(this.addOverlay_(a),e=!0)),f.x=f.x>>1,f.y=f.y>>1,g.x=g.x>>1,g.y=g.y>>1,--d}e&&this.notifyListeners_()},MarkerManager.prototype.removeMarker=function(a){for(var b=this.maxZoom_,c=!1,d=a.getPosition(),e=this.getTilePoint_(d,b,new google.maps.Size(0,0,0,0));b>=0;){var f=this.getGridCellNoCreate_(e.x,e.y,b);f&&this.removeFromArray_(f,a),b===this.mapZoom_&&this.isGridPointVisible_(e)&&(this.removeOverlay_(a),c=!0),e.x=e.x>>1,e.y=e.y>>1,--b}c&&this.notifyListeners_(),this.numMarkers_[a.MarkerManager_minZoom]--},MarkerManager.prototype.addMarkers=function(a,b,c){for(var d=this.getOptMaxZoom_(c),e=a.length-1;e>=0;e--)this.addMarkerBatch_(a[e],b,d);this.numMarkers_[b]+=a.length},MarkerManager.prototype.getOptMaxZoom_=function(a){return a||this.maxZoom_},MarkerManager.prototype.getMarkerCount=function(a){for(var b=0,c=0;a>=c;c++)b+=this.numMarkers_[c];return b},MarkerManager.prototype.getMarker=function(a,b,c){var d=new google.maps.LatLng(a,b),e=this.getTilePoint_(d,c,new google.maps.Size(0,0,0,0)),f=new google.maps.Marker({position:d}),g=this.getGridCellNoCreate_(e.x,e.y,c);if(void 0!==g)for(var h=0;h<g.length;h++)a===g[h].getPosition().lat()&&b===g[h].getPosition().lng()&&(f=g[h]);return f},MarkerManager.prototype.addMarker=function(a,b,c){var d=this.getOptMaxZoom_(c);this.addMarkerBatch_(a,b,d);var e=this.getTilePoint_(a.getPosition(),this.mapZoom_,new google.maps.Size(0,0,0,0));this.isGridPointVisible_(e)&&b<=this.shownBounds_.z&&this.shownBounds_.z<=d&&(this.addOverlay_(a),this.notifyListeners_()),this.numMarkers_[b]++},GridBounds.prototype.equals=function(a){return this.maxX===a.maxX&&this.maxY===a.maxY&&this.minX===a.minX&&this.minY===a.minY?!0:!1},GridBounds.prototype.containsPoint=function(a){var b=this;return b.minX<=a.x&&b.maxX>=a.x&&b.minY<=a.y&&b.maxY>=a.y},MarkerManager.prototype.getGridCellCreate_=function(a,b,c){var d=this.grid_[c];0>a&&(a+=this.gridWidth_[c]);var e=d[a];if(!e)return e=d[a]=[],e[b]=[];var f=e[b];return f?f:e[b]=[]},MarkerManager.prototype.getGridCellNoCreate_=function(a,b,c){var d=this.grid_[c];0>a&&(a+=this.gridWidth_[c]);var e=d[a];return e?e[b]:void 0},MarkerManager.prototype.getGridBounds_=function(a,b,c,d){b=Math.min(b,this.maxZoom_);var e=a.getSouthWest(),f=a.getNorthEast(),g=this.getTilePoint_(e,b,c),h=this.getTilePoint_(f,b,d),i=this.gridWidth_[b];(f.lng()<e.lng()||h.x<g.x)&&(g.x-=i),h.x-g.x+1>=i&&(g.x=0,h.x=i-1);var j=new GridBounds([g,h]);return j.z=b,j},MarkerManager.prototype.getMapGridBounds_=function(){return this.getGridBounds_(this.map_.getBounds(),this.mapZoom_,this.swPadding_,this.nePadding_)},MarkerManager.prototype.onMapMoveEnd_=function(){this.objectSetTimeout_(this,this.updateMarkers_,0)},MarkerManager.prototype.objectSetTimeout_=function(a,b,c){return window.setTimeout(function(){b.call(a)},c)},MarkerManager.prototype.visible=function(){return this.show_?!0:!1},MarkerManager.prototype.isHidden=function(){return!this.show_},MarkerManager.prototype.show=function(){this.show_=!0,this.refresh()},MarkerManager.prototype.hide=function(){this.show_=!1,this.refresh()},MarkerManager.prototype.toggle=function(){this.show_=!this.show_,this.refresh()},MarkerManager.prototype.refresh=function(){this.shownMarkers_>0&&this.processAll_(this.shownBounds_,this.removeOverlay_),this.show_&&this.processAll_(this.shownBounds_,this.addOverlay_),this.notifyListeners_()},MarkerManager.prototype.updateMarkers_=function(){this.mapZoom_=this.map_.getZoom();var a=this.getMapGridBounds_();a.equals(this.shownBounds_)&&a.z===this.shownBounds_.z||(a.z!==this.shownBounds_.z?(this.processAll_(this.shownBounds_,this.removeOverlay_),this.show_&&this.processAll_(a,this.addOverlay_)):(this.rectangleDiff_(this.shownBounds_,a,this.removeCellMarkers_),this.show_&&this.rectangleDiff_(a,this.shownBounds_,this.addCellMarkers_)),this.shownBounds_=a,this.notifyListeners_())},MarkerManager.prototype.notifyListeners_=function(){google.maps.event.trigger(this,"changed",this.shownBounds_,this.shownMarkers_)},MarkerManager.prototype.processAll_=function(a,b){for(var c=a.minX;c<=a.maxX;c++)for(var d=a.minY;d<=a.maxY;d++)this.processCellMarkers_(c,d,a.z,b)},MarkerManager.prototype.processCellMarkers_=function(a,b,c,d){var e=this.getGridCellNoCreate_(a,b,c);if(e)for(var f=e.length-1;f>=0;f--)d(e[f])},MarkerManager.prototype.removeCellMarkers_=function(a,b,c){this.processCellMarkers_(a,b,c,this.removeOverlay_)},MarkerManager.prototype.addCellMarkers_=function(a,b,c){this.processCellMarkers_(a,b,c,this.addOverlay_)},MarkerManager.prototype.rectangleDiff_=function(a,b,c){var d=this;d.rectangleDiffCoords_(a,b,function(b,e){c.apply(d,[b,e,a.z])})},MarkerManager.prototype.rectangleDiffCoords_=function(a,b,c){var d,e,f=a.minX,g=a.minY,h=a.maxX,i=a.maxY,j=b.minX,k=b.minY,l=b.maxX,m=b.maxY;for(d=f;h>=d;d++){for(e=g;i>=e&&k>e;e++)c(d,e);for(e=Math.max(m+1,g);i>=e;e++)c(d,e)}for(e=Math.max(g,k);e<=Math.min(i,m);e++){for(d=Math.min(h+1,j)-1;d>=f;d--)c(d,e);for(d=Math.max(f,l+1);h>=d;d++)c(d,e)}},MarkerManager.prototype.removeFromArray_=function(a,b,c){for(var d=0,e=0;e<a.length;++e)(a[e]===b||c&&a[e]===b)&&(a.splice(e--,1),d++);return d},ProjectionHelperOverlay.prototype=new google.maps.OverlayView,ProjectionHelperOverlay.prototype.LngToX_=function(a){return 1+a/180},ProjectionHelperOverlay.prototype.LatToY_=function(a){var b=Math.sin(a*Math.PI/180);return 1-.5/Math.PI*Math.log((1+b)/(1-b))},ProjectionHelperOverlay.prototype.LatLngToPixel=function(a,b){var c=(this._map,this.getProjection().fromLatLngToDivPixel(a),{x:~~(.5+this.LngToX_(a.lng())*(2<<b+6)),y:~~(.5+this.LatToY_(a.lat())*(2<<b+6))});return c},ProjectionHelperOverlay.prototype.draw=function(){this.ready||(this.ready=!0,google.maps.event.trigger(this,"ready"))};